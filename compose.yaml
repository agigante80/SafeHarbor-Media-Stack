# SafeHarbor Media Stack - Docker Compose Configuration
# 
# This setup provides a complete VPN-protected media automation stack:
# - All media containers route traffic through VPN (Gluetun)
# - External access via mapped ports on host network
# - Internal container communication via localhost (shared network stack)
# - Isolated monitoring system with Telegram notifications
# - Synology NAS compatible configuration
#
# Prerequisites:
# 1. Copy .env.example to .env and configure your values
# 2. Ensure Docker and Docker Compose are installed
# 3. Configure VPN provider credentials in .env file
# 4. Set up Telegram bot (optional) for monitoring
# 5. Ensure volume directories exist with proper permissions
#
# External Access Ports:
# - qBittorrent:  http://YOUR_SERVER_IP:9802
# - Jackett:      http://YOUR_SERVER_IP:9803  
# - Sonarr:       http://YOUR_SERVER_IP:9804
# - Prowlarr:     http://YOUR_SERVER_IP:9805
# - FlareSolverr: http://YOUR_SERVER_IP:9806
# - Readarr:      http://YOUR_SERVER_IP:9808
# - Radarr:       http://YOUR_SERVER_IP:9809
# - Bazarr:       http://YOUR_SERVER_IP:9810
# - Radarr_ES:    http://YOUR_SERVER_IP:9811
# - Keepalive:    http://YOUR_SERVER_IP:5421

version: "3"

services:
  # =============================================================================
  # VPN GATEWAY - All media traffic routes through this container
  # =============================================================================
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    cap_add:
      - NET_ADMIN  # Required for VPN tunnel creation
    devices:
      - /dev/net/tun:/dev/net/tun  # TUN device for VPN tunnel
    ports:
      # BitTorrent ports for qBittorrent
      - 9801:6881      # qBittorrent TCP port
      - 9801:6881/udp  # qBittorrent UDP port
      # Media application web interfaces (external:internal)
      - 9802:8085      # qBittorrent WebUI
      - 9803:9117      # Jackett indexer proxy
      - 9804:8989      # Sonarr TV shows management
      - 9805:9696      # Prowlarr indexer manager  
      - 9806:8191      # FlareSolverr Cloudflare bypass
      - 9808:8787      # Readarr books management
      - 9809:7878      # Radarr movies management
      - 9810:6767      # Bazarr subtitles management
      - 9811:7879      # Radarr_ES Spanish movies instance
    volumes:
      - ${VOLUME_DOCKER_PROJECT}/gluetun:/gluetun  # VPN config and logs
    environment:
      # VPN Provider Configuration (from .env file)
      - UPDATER_PERIOD=${UPDATER_PERIOD}              # How often to check for updates
      - VPN_SERVICE_PROVIDER=${VPN_SERVICE_PROVIDER}  # VPN provider name
      - SERVER_COUNTRIES=${SERVER_COUNTRIES}          # Preferred server countries
      - OPENVPN_USER=${VPN_USER}                      # VPN username
      - OPENVPN_PASSWORD=${VPN_PASSWORD}              # VPN password
      # Network Configuration
      - FIREWALL_OUTBOUND_SUBNETS=10.50.0.0/16,10.51.0.0/16  # Allow internal communication
    networks:
      - media-internal  # Connected to internal network for monitoring
    restart: always

  # =============================================================================
  # MEDIA STACK - All containers share Gluetun's VPN network
  # =============================================================================
  
  # BitTorrent Download Client
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent
    container_name: qbittorrent
    environment:
      - PUID=${PUID_MEDIA}       # User ID for file permissions
      - PGID=${PGID_MEDIA}       # Group ID for file permissions
      - TZ=${TZ}                 # Timezone setting
      - WEBUI_PORT=8085          # Internal web interface port
    volumes:
      - ${VOLUME_DOCKER_PROJECT}/qbittorrent/config:/config  # Configuration storage
      - ${VOLUME_DOWNLOADS}:/downloads                       # Completed downloads
      - ${VOLUME_INCOMPLETE}:/incomplete                     # Incomplete downloads
    network_mode: service:gluetun  # Share Gluetun's VPN network stack
    depends_on:
      - gluetun
    restart: unless-stopped

  # Cloudflare Bypass Service
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      - PUID=${PUID_MEDIA}      # User ID for file permissions
      - PGID=${PGID_MEDIA}      # Group ID for file permissions
      - TZ=${TZ}                # Timezone setting
      - TEST_URL=${TEST_URL}    # URL for connectivity testing
      - LANG=${LANG}            # Language setting
    network_mode: service:gluetun  # Share Gluetun's VPN network stack
    depends_on:
      - gluetun
    restart: unless-stopped

  # Torrent Indexer Proxy
  jackett:
    image: lscr.io/linuxserver/jackett:latest
    container_name: jackett
    environment:
      - PUID=${PUID_MEDIA}
      - PGID=${PGID_MEDIA}
      - TZ=${TZ}
      - AUTO_UPDATE=true
      - RUN_OPTS=
    volumes:
      - ${VOLUME_DOCKER_PROJECT}/jackett/config:/config
      - ${VOLUME_DOCKER_PROJECT}/jackett/downloads:/downloads
    network_mode: service:gluetun
    depends_on:
      - gluetun
      - flaresolverr
    restart: unless-stopped

  # Indexer Manager (Modern Jackett Alternative)
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID_MEDIA}
      - PGID=${PGID_MEDIA}
      - TZ=${TZ}
    volumes:
      - ${VOLUME_DOCKER_PROJECT}/prowlarr/config:/config
    network_mode: service:gluetun
    depends_on:
      - gluetun
    restart: unless-stopped

  # TV Show Automation (*arr Applications)
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=${PUID_MEDIA}
      - PGID=${PGID_MEDIA}
      - TZ=${TZ}
    volumes:
      - ${VOLUME_DOCKER_PROJECT}/sonarr/config:/config
      - ${VOLUME_DOWNLOADS}:/downloads
      - ${VOLUME_MEDIA}:/media/media
    network_mode: service:gluetun
    depends_on:
      - gluetun
    restart: unless-stopped

  # Movie Automation
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=${PUID_MEDIA}
      - PGID=${PGID_MEDIA}
      - TZ=${TZ}
    volumes:
      - ${VOLUME_DOCKER_PROJECT}/radarr/config:/config
      - ${VOLUME_DOWNLOADS}:/downloads
      - ${VOLUME_MEDIA}:/media/media
    network_mode: service:gluetun
    depends_on:
      - gluetun
    restart: unless-stopped

  # Book and Audiobook Automation  
  readarr:
    image: lscr.io/linuxserver/readarr:develop
    container_name: readarr
    environment:
      - PUID=${PUID_MEDIA}
      - PGID=${PGID_MEDIA}
      - TZ=${TZ}
    volumes:
      - ${VOLUME_DOCKER_PROJECT}/readarr/config:/config
      - ${VOLUME_DOWNLOADS}:/downloads
      - ${VOLUME_EBOOKS}:/ebooks
      - ${VOLUME_AUDIOBOOKS}:/audiobooks
      - ${VOLUME_IMPORT}:/ImportFolder
      - ${VOLUME_AUDIOBOOKSHELF}:/audiobookshelf
    network_mode: service:gluetun
    depends_on:
      - gluetun
    restart: unless-stopped

  # Subtitle Automation
  bazarr:
    image: lscr.io/linuxserver/bazarr:development
    container_name: bazarr
    environment:
      - PUID=${PUID_MEDIA}
      - PGID=${PGID_MEDIA}
      - TZ=${TZ}
    volumes:
      - ${VOLUME_DOCKER_PROJECT}/bazarr/config:/config
      - ${VOLUME_MEDIA}:/media/media
    network_mode: service:gluetun
    depends_on:
      - gluetun
    restart: unless-stopped

  # Spanish Movie Automation (Separate Instance)
  radarr_es:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr_es
    environment:
      - PUID=${PUID_MEDIA}
      - PGID=${PGID_MEDIA}
      - TZ=${TZ}
    volumes:
      - ${VOLUME_DOCKER_PROJECT}/radarr_ES/config:/config
      - ${VOLUME_DOWNLOADS}:/downloads
      - ${VOLUME_MEDIA}:/media/media
    network_mode: service:gluetun
    depends_on:
      - gluetun
    restart: unless-stopped

  # =============================================================================
  # VPN SENTINEL MONITORING - Telegram notifications for VPN status
  # Using VPNSentinel: https://github.com/agigante80/VPNSentinel
  # =============================================================================
  
  # VPN Sentinel Client (monitors from inside VPN network)
  vpn-sentinel-client:
    image: agigante80/vpn-sentinel-client:latest
    container_name: vpn-sentinel-client
    environment:
      - VPN_SENTINEL_SERVER_URL=http://vpn-sentinel-server:5000  # Internal server URL
      - VPN_SENTINEL_API_KEY=${VPN_SENTINEL_API_KEY}             # API key for authentication
      - VPN_SENTINEL_CLIENT_ID=${VPN_SENTINEL_CLIENT_ID:-safeharbor-media-stack}  # Unique client identifier
      - VPN_SENTINEL_CHECK_INTERVAL=${VPN_SENTINEL_CHECK_INTERVAL:-300}  # Check interval in seconds (5 minutes)
      - TZ=${TZ}                                                 # Timezone setting
    network_mode: service:gluetun  # Routes through VPN to monitor connectivity
    depends_on:
      - gluetun                    # Needs VPN gateway
      - vpn-sentinel-server        # Needs monitoring server
    restart: unless-stopped

  # VPN Sentinel Server (isolated network - uses real IP for Telegram)
  vpn-sentinel-server:
    image: agigante80/vpn-sentinel-server:latest
    container_name: vpn-sentinel-server
    ports:
      - "5421:5000"  # API server port
      - "8080:8080"  # Web dashboard port (optional)
      - "8081:8081"  # Health check port (optional)
    environment:
      - VPN_SENTINEL_API_KEY=${VPN_SENTINEL_API_KEY}                    # API key for security
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}                        # Telegram bot token for notifications
      - VPN_SENTINEL_TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}               # Your Telegram chat ID
      - VPN_SENTINEL_TELEGRAM_ENABLED=true                              # Enable Telegram notifications
      - VPN_SENTINEL_SERVER_API_PORT=5000                               # API server port
      - VPN_SENTINEL_SERVER_DASHBOARD_PORT=8080                         # Web dashboard port
      - VPN_SENTINEL_SERVER_HEALTH_PORT=8081                            # Health check port
      - VPN_SENTINEL_SERVER_WEB_DASHBOARD_ENABLED=true                  # Enable web dashboard
      - VPN_SENTINEL_ALERT_THRESHOLD_MINUTES=${VPN_SENTINEL_ALERT_THRESHOLD_MINUTES:-15}  # Alert after X minutes of no contact
      - VPN_SENTINEL_CHECK_INTERVAL_MINUTES=${VPN_SENTINEL_CHECK_INTERVAL_MINUTES:-5}     # Expected check interval
      - TZ=${TZ}                                                        # Timezone setting
    networks:
      - vpn-sentinel-isolated  # Isolated network (bypasses VPN)
    restart: unless-stopped

# =============================================================================
# NETWORK CONFIGURATION - Custom networks for proper isolation
# =============================================================================
networks:
  # Internal network for Gluetun VPN gateway
  # Used for communication between VPN container and monitoring
  media-internal:
    driver: bridge
    name: media-internal
    ipam:
      config:
        - subnet: 10.50.0.0/16  # Internal subnet for media services
  
  # Isolated network for VPN Sentinel server
  # Bypasses VPN to send Telegram notifications via real IP  
  vpn-sentinel-isolated:
    driver: bridge
    name: vpn-sentinel-isolated  
    ipam:
      config:
        - subnet: 10.51.0.0/16  # Isolated subnet for monitoring
